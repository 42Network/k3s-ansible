---
k3s_cluster:
  children:
    # -------------------------------------------------------
    # 1. K3s Control Plane (Servers)
    # -------------------------------------------------------
    server:
      hosts:
        marconi3:
          ansible_host: 10.203.248.233
          extra_server_args: "--node-taint CriticalAddonsOnly=true:NoSchedule"
        pve-teach-147:
          ansible_host: 10.203.248.147
          ansible_user: root
          extra_server_args: "--node-taint CriticalAddonsOnly=true:NoSchedule"
        pve-teach-150:
          ansible_host: 10.203.248.150
          ansible_user: root
          extra_server_args: "--node-taint CriticalAddonsOnly=true:NoSchedule"

    # -------------------------------------------------------
    # 2. K3s Workers (Agents)
    # -------------------------------------------------------
    agent:
      hosts:
        marconi1:
          ansible_host: 10.203.248.231
        marconi2:
          ansible_host: 10.203.248.232
        marconi4:
          ansible_host: 10.203.248.234
        marconi5:
          ansible_host: 10.203.248.235
        marconi6:
          ansible_host: 10.203.248.236
        marconi7:
          ansible_host: 10.203.248.237
        marconi8:
          ansible_host: 10.203.248.238
        pve-teach-133: { ansible_host: 10.203.248.133, ansible_user: root }
        pve-teach-134: { ansible_host: 10.203.248.134, ansible_user: root }
        pve-teach-136: { ansible_host: 10.203.248.136, ansible_user: root }
        pve-teach-137: { ansible_host: 10.203.248.137, ansible_user: root }
        pve-teach-138: { ansible_host: 10.203.248.138, ansible_user: root }
        pve-teach-139: { ansible_host: 10.203.248.139, ansible_user: root }
        pve-teach-140: { ansible_host: 10.203.248.140, ansible_user: root }
        pve-teach-141: { ansible_host: 10.203.248.141, ansible_user: root }
        pve-teach-142: { ansible_host: 10.203.248.142, ansible_user: root }
        pve-teach-143: { ansible_host: 10.203.248.143, ansible_user: root }
        pve-teach-144: { ansible_host: 10.203.248.144, ansible_user: root }
        pve-teach-145: { ansible_host: 10.203.248.145, ansible_user: root }
        pve-teach-146: { ansible_host: 10.203.248.146, ansible_user: root }

    # -------------------------------------------------------
    # 3. InfiniBand Managers (Running on Control Plane nodes)
    # -------------------------------------------------------
    ib_managers:
      hosts:
        # OpenSM Master (Priority 10)
        marconi1:
          ansible_host: 10.203.248.231
          sm_priority: 10
        # OpenSM Backup (Priority 5)
        marconi2:
          ansible_host: 10.203.248.232
          sm_priority: 5

  # ---------------------------------------------------------
  # Global Variables
  # ---------------------------------------------------------
  vars:
    ansible_port: 22
    ansible_user: openlab
    k3s_version: v1.31.12+k3s1
    token: "changeme!"
    
    # Increase Pod Capacity (Default 110 -> 200) to support COPIES=30+
    extra_server_args: "--kubelet-arg=max-pods=200"
    extra_agent_args: "--kubelet-arg=max-pods=200"

    # This automatically picks the IP of the first server (marconi1) as the API endpoint
    api_endpoint: "{{ hostvars[groups['server'][0]]['ansible_host'] | default(groups['server'][0]) }}"
